<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AOP Backend Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #e2e3e5; color: #383d41; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .results { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; max-height: 300px; overflow-y: auto; }
        pre { white-space: pre-wrap; font-size: 12px; }
        select { padding: 5px; margin: 5px; min-width: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ AOP Backend Test Page</h1>
        <p>This page tests the backend directly to identify Key Event search issues.</p>
        
        <div class="test-section">
            <h3>üåê Server Status</h3>
            <button onclick="testServerStatus()">Test Server Connection</button>
            <div id="server-status" class="results"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã Key Events</h3>
            <button onclick="loadKeyEvents()">Load Key Events</button>
            <div id="key-events-status" class="results"></div>
            <select id="key-events-select" size="10" style="width: 100%; margin-top: 10px;">
                <option>Click "Load Key Events" first</option>
            </select>
        </div>
        
        <div class="test-section">
            <h3>üéØ Key Event Search - Event:1282</h3>
            <button onclick="searchEvent1282()">Search Event:1282 (JAK/STAT)</button>
            <div id="search-results" class="results"></div>
        </div>
        
        <div class="test-section">
            <h3>üîç Custom Key Event Search</h3>
            <input type="text" id="custom-event" placeholder="Enter Event ID (e.g., Event:1282)" style="width: 200px;">
            <button onclick="searchCustomEvent()">Search Custom Event</button>
            <div id="custom-results" class="results"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:5001';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            element.innerHTML = `<div class="${type}">${logMessage}</div>` + element.innerHTML;
            console.log(logMessage);
        }
        
        async function testServerStatus() {
            log('server-status', 'üîç Testing server connection...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/aops`);
                
                if (response.ok) {
                    const data = await response.json();
                    log('server-status', `‚úÖ Server is running! Found ${data.length} AOPs`, 'success');
                } else {
                    log('server-status', `‚ùå Server error: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                log('server-status', `‚ùå Connection failed: ${error.message}`, 'error');
                log('server-status', 'üí° Make sure backend server is running: python main.py', 'info');
            }
        }
        
        async function loadKeyEvents() {
            log('key-events-status', 'üîç Loading key events...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/key_events`);
                
                if (response.ok) {
                    const data = await response.json();
                    const keyEvents = data.key_events || [];
                    
                    log('key-events-status', `‚úÖ Loaded ${keyEvents.length} key events`, 'success');
                    log('key-events-status', `üìä Total available: ${data.total_available || 'unknown'}`, 'info');
                    
                    // Populate select dropdown
                    const select = document.getElementById('key-events-select');
                    select.innerHTML = '';
                    
                    if (keyEvents.length === 0) {
                        select.innerHTML = '<option>No key events found</option>';
                        log('key-events-status', '‚ö†Ô∏è No key events returned from backend', 'error');
                    } else {
                        keyEvents.forEach(ke => {
                            const option = document.createElement('option');
                            option.value = ke.id;
                            option.textContent = `${ke.id} - ${ke.name} (${ke.type})`;
                            if (ke.id === 'Event:1282') {
                                option.style.backgroundColor = '#fff3cd';
                                option.style.fontWeight = 'bold';
                            }
                            select.appendChild(option);
                        });
                        
                        // Check for Event:1282
                        const event1282 = keyEvents.find(ke => ke.id === 'Event:1282');
                        if (event1282) {
                            log('key-events-status', `üéØ Found Event:1282: ${JSON.stringify(event1282)}`, 'success');
                        } else {
                            log('key-events-status', '‚ö†Ô∏è Event:1282 NOT found in key events list', 'error');
                        }
                    }
                    
                    // Show first few events
                    if (keyEvents.length > 0) {
                        const firstFew = keyEvents.slice(0, 5).map(ke => `${ke.id} (${ke.type})`).join(', ');
                        log('key-events-status', `üìã First few: ${firstFew}`, 'info');
                    }
                    
                } else {
                    log('key-events-status', `‚ùå HTTP ${response.status}: ${await response.text()}`, 'error');
                }
            } catch (error) {
                log('key-events-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function searchEvent1282() {
            await searchKeyEvent('Event:1282', 'search-results');
        }
        
        async function searchCustomEvent() {
            const eventId = document.getElementById('custom-event').value.trim();
            if (!eventId) {
                log('custom-results', '‚ùå Please enter an Event ID', 'error');
                return;
            }
            await searchKeyEvent(eventId, 'custom-results');
        }
        
        async function searchKeyEvent(eventId, resultElementId) {
            log(resultElementId, `üîç Searching for ${eventId}...`, 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/key_event_search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyEvents: [eventId]
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    log(resultElementId, `‚úÖ Search successful!`, 'success');
                    log(resultElementId, `üìä Found ${result.nodes?.length || 0} nodes, ${result.edges?.length || 0} edges`, 'info');
                    log(resultElementId, `üè¢ Affected AOPs: ${JSON.stringify(result.affected_aops)}`, 'info');
                    
                    if (result.nodes && result.nodes.length > 0) {
                        // Group nodes by AOP
                        const nodesByAOP = {};
                        result.nodes.forEach(node => {
                            const aop = node.aop || 'Unknown';
                            if (!nodesByAOP[aop]) nodesByAOP[aop] = [];
                            nodesByAOP[aop].push(`${node.id} (${node.type}) - ${node.label}`);
                        });
                        
                        let detailsHtml = '<h4>üìã Nodes by AOP:</h4>';
                        for (const [aop, nodes] of Object.entries(nodesByAOP)) {
                            detailsHtml += `<strong>${aop}:</strong><br>`;
                            nodes.forEach(node => {
                                detailsHtml += `&nbsp;&nbsp;- ${node}<br>`;
                            });
                            detailsHtml += '<br>';
                        }
                        
                        document.getElementById(resultElementId).innerHTML = detailsHtml + document.getElementById(resultElementId).innerHTML;
                        
                        // Check for expected AOP:208 events
                        if (eventId === 'Event:1282') {
                            const aop208Events = result.nodes.filter(n => n.aop === 'Aop:208').map(n => n.id);
                            const expected = ['Event:1282', 'Event:1283', 'Event:1277'];
                            const missing = expected.filter(e => !aop208Events.includes(e));
                            
                            if (missing.length === 0) {
                                log(resultElementId, `‚úÖ All expected AOP:208 events found: ${aop208Events.join(', ')}`, 'success');
                            } else {
                                log(resultElementId, `‚ùå Missing AOP:208 events: ${missing.join(', ')}`, 'error');
                            }
                            
                            // Check for cross-AOP connections
                            const aop347Events = result.nodes.filter(n => n.aop === 'Aop:347');
                            if (aop347Events.length > 0) {
                                log(resultElementId, `üîó Found ${aop347Events.length} cross-AOP events in AOP:347`, 'success');
                                const mies = aop347Events.filter(n => n.type === 'MolecularInitiatingEvent');
                                if (mies.length > 0) {
                                    log(resultElementId, `üß¨ Found ${mies.length} MIEs: ${mies.map(m => m.id).join(', ')}`, 'success');
                                }
                            }
                        }
                        
                    } else {
                        log(resultElementId, '‚ö†Ô∏è No nodes found in search results', 'error');
                    }
                    
                } else {
                    const errorText = await response.text();
                    log(resultElementId, `‚ùå Search failed: HTTP ${response.status} - ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(resultElementId, `‚ùå Search error: ${error.message}`, 'error');
            }
        }
        
        // Auto-test on page load
        window.addEventListener('load', () => {
            setTimeout(testServerStatus, 500);
        });
    </script>
</body>
</html>
