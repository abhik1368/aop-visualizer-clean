<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Event Search Test - White Screen Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .info { background-color: #e2e3e5; color: #383d41; border-color: #d6d8db; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .results { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; }
        pre { white-space: pre-wrap; font-size: 12px; font-family: 'Courier New', monospace; }
        .log-entry { margin: 5px 0; padding: 5px; border-radius: 3px; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        select { padding: 5px; margin: 5px; min-width: 200px; }
        input { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-green { background-color: #28a745; }
        .status-red { background-color: #dc3545; }
        .status-yellow { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚨 Key Event Search - White Screen Debug Tool</h1>
        <p><strong>Purpose:</strong> This tool mimics the React frontend Key Event search to identify why the screen goes white.</p>
        
        <div class="test-section">
            <h3><span id="server-indicator" class="status-indicator status-red"></span>Backend Server Status</h3>
            <button onclick="checkServerStatus()">🔍 Check Server</button>
            <button onclick="startServerMonitoring()">📊 Monitor Server</button>
            <div id="server-status" class="results">Click "Check Server" to test backend connection...</div>
        </div>
        
        <div class="grid">
            <div>
                <div class="test-section">
                    <h3>🔧 1. Load Key Events</h3>
                    <button onclick="loadKeyEvents()" id="load-ke-btn">📋 Load Key Events</button>
                    <div id="key-events-status" class="results">Click "Load Key Events" to fetch available events...</div>
                    <select id="key-events-select" size="8" style="width: 100%; margin-top: 10px;">
                        <option>Loading...</option>
                    </select>
                </div>
                
                <div class="test-section">
                    <h3>🎯 2. Test Event:1282 Search</h3>
                    <button onclick="testEvent1282()" id="test-1282-btn">🔍 Search Event:1282</button>
                    <div id="event-1282-results" class="results">Click to test Event:1282 search...</div>
                </div>
            </div>
            
            <div>
                <div class="test-section">
                    <h3>🧪 3. Custom Event Search</h3>
                    <input type="text" id="custom-event-input" placeholder="Enter Event ID (e.g., Event:1283)" style="width: 200px;">
                    <button onclick="testCustomEvent()" id="custom-test-btn">🔍 Search</button>
                    <div id="custom-results" class="results">Enter an Event ID and click Search...</div>
                </div>
                
                <div class="test-section">
                    <h3>🔍 4. Simulation Results</h3>
                    <div id="simulation-area" class="results">
                        <div class="info">This area will show what the React app should render...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>📊 Complete Test Report</h3>
            <button onclick="runCompleteTest()" id="complete-test-btn">🚀 Run Complete Test</button>
            <div id="complete-test-results" class="results">Click "Run Complete Test" for comprehensive analysis...</div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:5001';
        let serverMonitorInterval = null;
        
        function log(elementId, message, type = 'info', timestamp = true) {
            const element = document.getElementById(elementId);
            const time = timestamp ? new Date().toLocaleTimeString() : '';
            const logMessage = timestamp ? `[${time}] ${message}` : message;
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = logMessage;
            
            element.insertBefore(logEntry, element.firstChild);
            console.log(logMessage);
            
            // Keep only last 20 entries
            while (element.children.length > 20) {
                element.removeChild(element.lastChild);
            }
        }
        
        function setServerIndicator(status) {
            const indicator = document.getElementById('server-indicator');
            indicator.className = `status-indicator ${status}`;
        }
        
        async function checkServerStatus() {
            log('server-status', '🔍 Checking server connection...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/aops`, { 
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('server-status', `✅ Server is running! Found ${data.length} AOPs`, 'success');
                    setServerIndicator('status-green');
                    return true;
                } else {
                    log('server-status', `❌ Server error: HTTP ${response.status} ${response.statusText}`, 'error');
                    setServerIndicator('status-red');
                    return false;
                }
            } catch (error) {
                log('server-status', `❌ Connection failed: ${error.message}`, 'error');
                log('server-status', '💡 Start backend: cd backend/src && python main.py', 'warning');
                setServerIndicator('status-red');
                return false;
            }
        }
        
        function startServerMonitoring() {
            if (serverMonitorInterval) {
                clearInterval(serverMonitorInterval);
                serverMonitorInterval = null;
                log('server-status', '⏹️ Stopped server monitoring', 'info');
                return;
            }
            
            log('server-status', '▶️ Started server monitoring (every 5 seconds)', 'info');
            serverMonitorInterval = setInterval(async () => {
                const isUp = await checkServerStatus();
                setServerIndicator(isUp ? 'status-green' : 'status-red');
            }, 5000);
        }
        
        async function loadKeyEvents() {
            const btn = document.getElementById('load-ke-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Loading...';
            
            log('key-events-status', '🔍 Loading key events from backend...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/key_events`);
                
                if (response.ok) {
                    const data = await response.json();
                    const keyEvents = data.key_events || [];
                    
                    log('key-events-status', `✅ Loaded ${keyEvents.length} key events`, 'success');
                    log('key-events-status', `📊 Response: ${JSON.stringify(data, null, 2)}`, 'info');
                    
                    // Populate select dropdown
                    const select = document.getElementById('key-events-select');
                    select.innerHTML = '';
                    
                    if (keyEvents.length === 0) {
                        select.innerHTML = '<option>❌ No key events found</option>';
                        log('key-events-status', '⚠️ No key events returned - this will cause blank screen!', 'error');
                    } else {
                        keyEvents.forEach((ke, index) => {
                            const option = document.createElement('option');
                            option.value = ke.id;
                            option.textContent = `${ke.id} - ${ke.name} (${ke.type})`;
                            if (ke.id === 'Event:1282') {
                                option.style.backgroundColor = '#fff3cd';
                                option.style.fontWeight = 'bold';
                            }
                            select.appendChild(option);
                        });
                        
                        // Check for Event:1282
                        const event1282 = keyEvents.find(ke => ke.id === 'Event:1282');
                        if (event1282) {
                            log('key-events-status', `🎯 Event:1282 found: ${JSON.stringify(event1282)}`, 'success');
                        } else {
                            log('key-events-status', '⚠️ Event:1282 NOT found in list', 'warning');
                        }
                    }
                    
                } else {
                    const errorText = await response.text();
                    log('key-events-status', `❌ HTTP ${response.status}: ${errorText}`, 'error');
                }
            } catch (error) {
                log('key-events-status', `❌ Error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '📋 Load Key Events';
            }
        }
        
        async function testEvent1282() {
            await searchKeyEvent('Event:1282', 'event-1282-results', 'test-1282-btn');
        }
        
        async function testCustomEvent() {
            const eventId = document.getElementById('custom-event-input').value.trim();
            if (!eventId) {
                log('custom-results', '❌ Please enter an Event ID', 'error');
                return;
            }
            await searchKeyEvent(eventId, 'custom-results', 'custom-test-btn');
        }
        
        async function searchKeyEvent(eventId, resultElementId, buttonId) {
            const btn = document.getElementById(buttonId);
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Searching...';
            
            log(resultElementId, `🔍 Searching for ${eventId}...`, 'info');
            
            try {
                const requestData = { keyEvents: [eventId] };
                log(resultElementId, `📤 Request: ${JSON.stringify(requestData)}`, 'info');
                
                const response = await fetch(`${BASE_URL}/key_event_search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                log(resultElementId, `📡 Response status: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    
                    log(resultElementId, `✅ Search successful!`, 'success');
                    log(resultElementId, `📊 Found ${result.nodes?.length || 0} nodes, ${result.edges?.length || 0} edges`, 'info');
                    log(resultElementId, `🏢 Affected AOPs: ${JSON.stringify(result.affected_aops)}`, 'info');
                    
                    // SIMULATE WHAT REACT APP SHOULD DO
                    simulateReactRendering(result, eventId);
                    
                    if (result.nodes && result.nodes.length > 0) {
                        // Show detailed analysis
                        const nodesByAOP = {};
                        result.nodes.forEach(node => {
                            const aop = node.aop || 'Unknown';
                            if (!nodesByAOP[aop]) nodesByAOP[aop] = [];
                            nodesByAOP[aop].push(`${node.id} (${node.type}) - ${node.label}`);
                        });
                        
                        let analysis = '<h4>📋 Detailed Analysis:</h4>';
                        for (const [aop, nodes] of Object.entries(nodesByAOP)) {
                            analysis += `<strong>${aop} (${nodes.length} nodes):</strong><br>`;
                            nodes.forEach(node => {
                                analysis += `&nbsp;&nbsp;• ${node}<br>`;
                            });
                            analysis += '<br>';
                        }
                        
                        log(resultElementId, analysis, 'success', false);
                        
                        // Check for expected results
                        if (eventId === 'Event:1282') {
                            validateEvent1282Results(result, resultElementId);
                        }
                        
                    } else {
                        log(resultElementId, '❌ NO NODES FOUND - This causes white screen!', 'error');
                        log(resultElementId, '🔧 Possible causes: No pathway connections, data missing, server error', 'warning');
                    }
                    
                } else {
                    const errorText = await response.text();
                    log(resultElementId, `❌ Search failed: HTTP ${response.status} - ${errorText}`, 'error');
                    log(resultElementId, '🔧 This HTTP error could cause white screen in React app', 'warning');
                }
                
            } catch (error) {
                log(resultElementId, `❌ Search error: ${error.message}`, 'error');
                log(resultElementId, '🔧 This network error will definitely cause white screen', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = buttonId.includes('1282') ? '🔍 Search Event:1282' : '🔍 Search';
            }
        }
        
        function simulateReactRendering(result, eventId) {
            const simulationArea = document.getElementById('simulation-area');
            
            if (!result.nodes || result.nodes.length === 0) {
                simulationArea.innerHTML = `
                    <div class="error">
                        <h4>🚨 SIMULATION: React App Would Show White Screen</h4>
                        <p><strong>Reason:</strong> No nodes returned from backend</p>
                        <p><strong>Fix:</strong> Backend needs to return valid pathway data</p>
                    </div>
                `;
                return;
            }
            
            simulationArea.innerHTML = `
                <div class="success">
                    <h4>✅ SIMULATION: React App Should Render Graph</h4>
                    <p><strong>Event:</strong> ${eventId}</p>
                    <p><strong>Nodes:</strong> ${result.nodes.length}</p>
                    <p><strong>Edges:</strong> ${result.edges.length}</p>
                    <p><strong>AOPs:</strong> ${result.affected_aops?.join(', ') || 'Unknown'}</p>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px;">
                        <strong>Graph Data Preview:</strong><br>
                        <code>${JSON.stringify({nodes: result.nodes.slice(0,2), edges: result.edges.slice(0,2)}, null, 2)}</code>
                    </div>
                </div>
            `;
        }
        
        function validateEvent1282Results(result, resultElementId) {
            const aop208Events = result.nodes.filter(n => n.aop === 'Aop:208').map(n => n.id);
            const expected208 = ['Event:1282', 'Event:1283', 'Event:1277'];
            const missing208 = expected208.filter(e => !aop208Events.includes(e));
            
            if (missing208.length === 0) {
                log(resultElementId, `✅ All expected AOP:208 events found: ${aop208Events.join(', ')}`, 'success');
            } else {
                log(resultElementId, `❌ Missing AOP:208 events: ${missing208.join(', ')}`, 'error');
            }
            
            // Check cross-AOP connections
            const aop347Events = result.nodes.filter(n => n.aop === 'Aop:347');
            if (aop347Events.length > 0) {
                log(resultElementId, `🔗 Found ${aop347Events.length} cross-AOP events in AOP:347`, 'success');
                const mies = aop347Events.filter(n => n.type === 'MolecularInitiatingEvent');
                if (mies.length > 0) {
                    log(resultElementId, `🧬 Found ${mies.length} MIEs: ${mies.map(m => m.id).join(', ')}`, 'success');
                }
            } else {
                log(resultElementId, '⚠️ No cross-AOP connections found to AOP:347', 'warning');
            }
        }
        
        async function runCompleteTest() {
            const btn = document.getElementById('complete-test-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Running Tests...';
            
            log('complete-test-results', '🚀 Starting comprehensive test suite...', 'info');
            
            // Test 1: Server Status
            log('complete-test-results', '📋 Test 1: Server Status', 'info');
            const serverOk = await checkServerStatus();
            
            // Test 2: Key Events Loading
            log('complete-test-results', '📋 Test 2: Key Events Loading', 'info');
            await loadKeyEvents();
            
            // Test 3: Event:1282 Search
            log('complete-test-results', '📋 Test 3: Event:1282 Search', 'info');
            await testEvent1282();
            
            // Final Summary
            log('complete-test-results', '📊 TEST SUMMARY:', 'info');
            log('complete-test-results', `Server Status: ${serverOk ? '✅ OK' : '❌ FAILED'}`, serverOk ? 'success' : 'error');
            
            const keyEventsCount = document.getElementById('key-events-select').children.length;
            log('complete-test-results', `Key Events: ${keyEventsCount > 1 ? '✅ LOADED' : '❌ FAILED'} (${keyEventsCount} events)`, keyEventsCount > 1 ? 'success' : 'error');
            
            log('complete-test-results', '🔧 DIAGNOSIS:', 'info');
            if (!serverOk) {
                log('complete-test-results', '• Server not running - this will cause white screen', 'error');
            }
            if (keyEventsCount <= 1) {
                log('complete-test-results', '• No key events loaded - dropdown will be empty', 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '🚀 Run Complete Test';
        }
        
        // Auto-start on page load
        window.addEventListener('load', () => {
            log('server-status', '🌐 Page loaded - checking initial status...', 'info');
            setTimeout(checkServerStatus, 500);
        });
    </script>
</body>
</html>
